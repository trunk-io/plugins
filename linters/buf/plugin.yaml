version: 0.1
lint:
  definitions:
    - name: buf-format
      files: [proto]
      tools: [buf]
      suggest_if: never
      description: Formatter for Protobuf
      commands:
        - name: format
          output: rewrite
          run: buf format -w --path=${target}
          success_codes: [0, 100]
          cache_results: true
          formatter: true
          in_place: true
          batch: true
      environment:
        - name: PATH
          # needs system path for `diff`
          list: ["${linter}", "${env.PATH}"]
        - name: BUF_TOKEN
          list: ["${env.BUF_TOKEN}"]
          optional: true
      issue_url_format: https://docs.buf.build/lint/rules#{}
      direct_configs: [buf.yaml]
      affects_cache:
        - buf.lock
        - buf.gen.yaml
        - buf.work.yaml
      known_good_version: 1.55.1 # format subcommand was added in 1.2.0
      version_command:
        parse_regex: ${semver}
        run: buf --version

    - name: buf-lint
      files: [proto]
      tools: [buf]
      description: Accelerate Protobuf development with Buf
      commands:
        - name: lint
          output: buf
          run: buf lint --path ${target} --error-format json
          success_codes: [0, 100]
          run_from: ${root_or_parent_with(buf.yaml)}
      direct_configs: [buf.yaml]
      suggest_if: config_present
      environment:
        - name: PATH
          list: ["${linter}"]
        - name: BUF_TOKEN
          list: ["${env.BUF_TOKEN}"]
          optional: true
      affects_cache:
        - buf.lock
        - buf.gen.yaml
        - buf.work.yaml
      issue_url_format: https://docs.buf.build/lint/rules#{}
      known_good_version: 1.55.1 # newer version is needed to support Windows fully
      version_command:
        parse_regex: ${semver}
        run: buf --version

    - name: buf-breaking
      files: [proto]
      tools: [buf]
      suggest_if: never
      description: Check for breaking Protobuf API changes
      commands:
        - name: lint
          output: buf
          target: ${root_or_parent_with(buf.work.yaml)}
          run:
            buf breaking --against .git#branch=${upstream-ref} --error-format json
            --disable-symlinks
          success_codes: [0, 1, 100]
          run_from: ${root_or_parent_with(buf.work.yaml)}
          # buf is configured to not follow symlinks, and relies on git state, so don't cache results
          sandbox_type: copy_targets
          cache_results: false
      direct_configs: [buf.yaml, buf.work.yaml]
      environment:
        - name: PATH
          # Buf requires access to git to checkout/build upstream
          list: ["${linter}", "${env.PATH}"]
        - name: BUF_TOKEN
          list: ["${env.BUF_TOKEN}"]
          optional: true
      affects_cache:
        - buf.lock
        - buf.gen.yaml
        - buf.work.yaml
      issue_url_format: https://docs.buf.build/breaking/rules#{}
      known_good_version: 1.55.1
      version_command:
        parse_regex: ${semver}
        run: buf --version
